#!/bin/bash
# Enhanced ghup function with upstream tracking support

ghup() {
    # Check if we're in a git repository
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "❌ Not in a git repository"
        return 1
    fi

    local current_branch=$(git branch --show-current)
    local timestamp=$(date +"%Y-%m-%d_%H-%M-%S")
    local commit_msg="${timestamp}+${1:-auto_commit}"

    echo "🔄 Committing and pushing changes: $commit_msg"

    # Add all changes
    git add .

    # Check if there are changes to commit
    if git diff --staged --quiet; then
        echo "📝 No changes to commit"
    else
        # Commit changes
        git commit -m "$commit_msg"
    fi

    # Check if remote exists
    if ! git remote get-url origin > /dev/null 2>&1; then
        echo "❌ No remote 'origin' configured"
        echo "💡 Set up remote with: git remote add origin https://github.com/yourusername/repo.git"
        return 1
    fi

    # Check if current branch has upstream tracking
    if ! git rev-parse --abbrev-ref @{upstream} > /dev/null 2>&1; then
        echo "🔧 Setting up upstream tracking for branch: $current_branch"
        git push --set-upstream origin "$current_branch"
    else
        # Normal push
        git push
    fi

    # Check if push was successful
    if [ $? -eq 0 ]; then
        echo "✅ Successfully pushed to origin/$current_branch"

        # Show some helpful info for ABK repos
        if [[ "$(basename "$PWD")" == "abk" ]]; then
            echo "📊 ABK Status:"
            echo "   Branch: $current_branch"
            echo "   Size: $(du -sh --exclude=.git . | cut -f1)"
            echo "   Last commit: $(git log -1 --format="%ar" 2>/dev/null)"
        fi
    else
        echo "❌ Push failed"
        return 1
    fi
}
